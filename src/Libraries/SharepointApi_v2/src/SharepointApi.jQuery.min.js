/**
 * @Title Sharepoint.jQuery.min.js
 * @Author Wilfredo Pacheco
 * @Direrctory /
 * @Description Header definitions for REST Api calls to Microsoft SharePoint Site Collections.
 * Microsoft Internet Explorer friendly, gets assigned to the global window Object.
 * @Copyright (C) 2021 Wilfredo Pacheco
 */


(function(Route, Headers){

    /** Start Header */
    const Content_Type = 'Content-Type';
    const Accept = 'Accept';
    const X_RequestDigest = 'X-RequestDigest'
    const X_HTTP_Method = 'X-HTTP-Method';
    const IF_MATCH = 'IF-MATCH';
    const DELETE_String = 'DELETE';

    /** Values */
    const charsetUTF8 = 'application/json; charset=UTF-8';
    const verbose = 'application/json; odata=verbose';
    const MERGE = 'MERGE';
    const ASTERISK = '*';

    /** GET Headers */
    const SharepointGET_Headers = new Object();
    SharepointGET_Headers[Content_Type] = charsetUTF8;
    SharepointGET_Headers[Accept] = verbose;

    /** POST Headers */
    const SharepointPOST_Headers = new Object();
    SharepointPOST_Headers[Content_Type] = verbose;
    SharepointPOST_Headers[Accept] = verbose;
    SharepointPOST_Headers[X_RequestDigest] = null;

    /** PATCH Headers */
    const SharepointPATCH_Headers = new Object();
    SharepointPATCH_Headers[Content_Type] = verbose;
    SharepointPATCH_Headers[Accept] = verbose;
    SharepointPATCH_Headers[X_HTTP_Method] = MERGE;
    SharepointPATCH_Headers[X_RequestDigest] = null;
    SharepointPATCH_Headers[IF_MATCH] = ASTERISK;

    /** DELETE Headers */
    const SharepointDELETE_Headers = new Object();
    SharepointDELETE_Headers[Content_Type] = verbose;
    SharepointDELETE_Headers[Accept] = verbose;
    SharepointDELETE_Headers[X_HTTP_Method] = DELETE_String;
    SharepointDELETE_Headers[X_RequestDigest] = null;
    SharepointDELETE_Headers[IF_MATCH] = ASTERISK;

    /** REQUEST DIGEST Headers */
    const SharepointREQUESTDIGEST_Headers = new Object();
    SharepointREQUESTDIGEST_Headers[Accept] = verbose;

    /** End Header */
    
    /** Start Route */
    Route = new Object();
    Headers = {
        GET: SharepointGET_Headers,
        POST: SharepointPOST_Headers,
        PATCH: SharepointPATCH_Headers,
        DELETE: SharepointDELETE_Headers,
        REQUEST_DIGEST: SharepointREQUESTDIGEST_Headers,
    }
    
    var Get,
        POST,
        Patch,
        DELETE,
        getRequestDigest,
        getWeb;
    
    var WebPath = '/_api/web';
    var contextinfoPath = '/_api/contextinfo';
    var URLTOKEN = '/SiteAssets'
    
    /** Properties */
    Route.Headers = Headers;

    getWeb = Route.getWeb = function getWeb(url, data){
        url = location.href.split(URLTOKEN) + WebPath;
        return $.ajax({
            url: url,
            method: 'GET',
            dataType: 'json',
            data: !data ? '' : data,
            headers: Headers.GET,
        });
    }

    getRequestDigest = Route.getRequestDigest = function getRequestDigest(url){
        return $.ajax({
            url: url + contextinfoPath,
            method: 'POST',
            dataType: 'json',
            headers: Headers.REQUEST_DIGEST,
        });
    }
    
    Get = Route.Get = function GET(url, data){
        return $.ajax({
            url: url,
            method: 'GET',
            dataType: 'json',
            data: !data ? '' : data,
            headers: Headers.GET,
        });
    }

    Post = Route.Post = function POST(url, data, RequestDigest){
        return getRequestDigest().done(function(data){
            var headers = Headers.POST;
            headers[X_RequestDigest] = data.d.GetContextWebInformation.FormDigestValue;
            return $.ajax({
                url: url,
                method: 'POST',
                dataType: 'json',
                data: typeof(data) === 'string' ? data : JSON.stringify(data),
                headers: headers,
            });
        });
    }

    Patch = Route.Patch = function PATCH(url, data, RequestDigest){
        return getRequestDigest().done(function(data){
            var headers = Headers.PATCH;
            headers[X_RequestDigest] = data.d.GetContextWebInformation.FormDigestValue;
            return $.ajax({
                url: url,
                method: 'POST',
                dataType: 'json',
                data: typeof(data) === 'string' ? data : JSON.stringify(data),
                headers: headers,
            });
        });
    }

    DELETE = Route.Delete = function DELETE(url){
        return getRequestDigest().done(function(data){
            var headers = Headers.DELETE;
            headers[X_RequestDigest] = data.d.GetContextWebInformation.FormDigestValue;
            return $.ajax({
                url: url,
                method: 'POST',
                dataType: 'json',
                data: typeof(data) === 'string' ? data : JSON.stringify(data),
                headers: headers,
            });
        });            
    }

    /**
     * @reference: https://docs.microsoft.com/en-us/previous-versions/office/developer/sharepoint-rest-reference/dn531432(v=office.15)
     * */
    function getQueryStringParameter(paramToRetrieve) {
        var params =
            document.URL.split("?")[1].split("&amp;");
        var strParams = "";
        for (var i = 0; i < params.length; i = i + 1) {
          var singleParam = params[i].split("=");
          if (singleParam[0] == paramToRetrieve)
            return singleParam[1];
        }
    }

    window.Route = Route;
})();